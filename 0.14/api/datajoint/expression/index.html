
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../errors/">
      
      
        <link rel="next" href="../external/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/company-logo-blue.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>expression.py - DataJoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto Slab";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#datajoint.expression" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DataJoint Documentation" class="md-header__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
      
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataJoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              expression.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datajoint/datajoint-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/datajoint-python
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!-- Reference from: https://github.com/squidfunk/mkdocs-material/blob/master/src/templates/partials/nav.html -->



<!-- Determine classes -->



  


<!-- Navigation -->
<nav
  class="md-nav md-nav--primary md-nav--integrated"
  aria-label="Navigation"
  data-md-level="0"
>

  <!-- Site title -->
  <label class="md-nav__title" for="__drawer">
    <a
      href="../../.."
      title="DataJoint Documentation"
      class="md-nav__button md-logo"
      aria-label="DataJoint Documentation"
      data-md-component="logo"
    >
      
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

    </a>
    <!-- Add DataJoint home link to navigation header, otherwise unchanged -->
    <!-- DataJoint Documentation -->
    <a href="https://docs.datajoint.com" title="DataJoint">
      â¬… Home
    </a>
  </label>

  <!-- Repository information -->
  
    <div class="md-nav__source">
      <a href="https://github.com/datajoint/datajoint-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/datajoint-python
  </div>
</a>
    </div>
  

  <!-- Navigation list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DataJoint Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/data-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/data-pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Pipelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/teamwork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Teamwork
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/terminology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terminology
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    System Administration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    System Administration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../sysadmin/database-admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Database Administration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../sysadmin/bulk-storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bulk Storage Systems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../sysadmin/external-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    External Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Client Configuration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Client Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/credentials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/stores.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Stores
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schema Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schema Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Creation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Table Definition
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Table Definition
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/tiers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Table Tiers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/declare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Declaration Syntax
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/primary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Primary Key
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/attributes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attributes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/lookup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lookup Tables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manual Tables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/blobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blobs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/attach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attachments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/filepath/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filepaths
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/customtype/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Datatypes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dependencies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/indexes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Indexes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tables/master-part/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Master-Part Relationships
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/diagrams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Diagrams
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/normalization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entity Normalization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/integrity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Integrity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/recall/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Recall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/drop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Drop
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/alter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Modification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../manipulation/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Data Manipulations
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Manipulations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manipulation/insert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Insert
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manipulation/delete/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Delete
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manipulation/update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Update
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manipulation/transactions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Transactions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Queries
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Queries
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/example-schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Example Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/fetch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fetch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/iteration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Iteration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/restrict/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Restrict
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Projection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/join/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Join
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Aggregation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/union/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Union
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/universals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Universal Sets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../query/query-caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Query Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Computations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Computations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../compute/make/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Make Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../compute/populate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Populate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../compute/key-source/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Key Source
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../compute/distributed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Computing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../publish-data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Publish Data
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Internals
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Internals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../internal/transpilation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SQL Transpilation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/json/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using the json type
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../develop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Developer Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../citation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Citation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" checked>
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17_1" checked>
        
          
          <label class="md-nav__link" for="__nav_17_1" id="__nav_17_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    datajoint
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_17_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_17_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    datajoint
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../__init__/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    __init__.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    admin.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attribute_adapter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    attribute_adapter.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../autopopulate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    autopopulate.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../blob/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    blob.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cli.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../condition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    condition.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../connection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    connection.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../declare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    declare.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    dependencies.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../diagram/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    diagram.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    errors.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    expression.py
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    expression.py
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#datajoint.expression" class="md-nav__link">
    <span class="md-ellipsis">
      
        expression
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression" class="md-nav__link">
    <span class="md-ellipsis">
      
        QueryExpression
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QueryExpression">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        connection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.support" class="md-nav__link">
    <span class="md-ellipsis">
      
        support
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.heading" class="md-nav__link">
    <span class="md-ellipsis">
      
        heading
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.original_heading" class="md-nav__link">
    <span class="md-ellipsis">
      
        original_heading
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.restriction" class="md-nav__link">
    <span class="md-ellipsis">
      
        restriction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.restriction_attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        restriction_attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.make_sql" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_sql
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.make_subquery" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_subquery
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.restrict" class="md-nav__link">
    <span class="md-ellipsis">
      
        restrict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.join" class="md-nav__link">
    <span class="md-ellipsis">
      
        join
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.proj" class="md-nav__link">
    <span class="md-ellipsis">
      
        proj
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.aggr" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.head" class="md-nav__link">
    <span class="md-ellipsis">
      
        head
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.tail" class="md-nav__link">
    <span class="md-ellipsis">
      
        tail
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.cursor" class="md-nav__link">
    <span class="md-ellipsis">
      
        cursor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.QueryExpression.preview" class="md-nav__link">
    <span class="md-ellipsis">
      
        preview
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datajoint.expression.Aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datajoint.expression.Union" class="md-nav__link">
    <span class="md-ellipsis">
      
        Union
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Union">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.Union.from_clause" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_clause
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.Union.where_clause" class="md-nav__link">
    <span class="md-ellipsis">
      
        where_clause
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datajoint.expression.U" class="md-nav__link">
    <span class="md-ellipsis">
      
        U
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="U">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.U.join" class="md-nav__link">
    <span class="md-ellipsis">
      
        join
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datajoint.expression.U.aggr" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggr
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    external.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fetch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fetch.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hash.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    heading.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    jobs.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    logging.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    plugin.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../preview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    preview.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    s3.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    schemas.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    settings.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../table/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    table.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user_tables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    user_tables.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../version/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    version.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>expression.py</h1>

<div class="doc doc-object doc-module">



<a id="datajoint.expression"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">















































<div class="doc doc-object doc-class">



<h2 id="datajoint.expression.QueryExpression" class="doc doc-heading">
            <code>QueryExpression</code>


<a href="#datajoint.expression.QueryExpression" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>QueryExpression implements query operators to derive new entity set from its input.
A QueryExpression object generates a SELECT statement in SQL.
QueryExpression operators are restrict, join, proj, aggr, and union.</p>
<p>A QueryExpression object has a support, a restriction (an AndList), and heading.
Property <code>heading</code> (type dj.Heading) contains information about the attributes.
It is loaded from the database and updated by proj.</p>
<p>Property <code>support</code> is the list of table names or other QueryExpressions to be joined.</p>
<p>The restriction is applied first without having access to the attributes generated by the projection.
Then projection is applied by selecting modifying the heading attribute.</p>
<p>Application of operators does not always lead to the creation of a subquery.
A subquery is generated when:
    1. A restriction is applied on any computed or renamed attributes
    2. A projection is applied remapping remapped attributes
    3. Subclasses: Join, Aggregation, and Union have additional specific rules.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>datajoint/expression.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">QueryExpression</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    QueryExpression implements query operators to derive new entity set from its input.</span>
<span class="sd">    A QueryExpression object generates a SELECT statement in SQL.</span>
<span class="sd">    QueryExpression operators are restrict, join, proj, aggr, and union.</span>

<span class="sd">    A QueryExpression object has a support, a restriction (an AndList), and heading.</span>
<span class="sd">    Property `heading` (type dj.Heading) contains information about the attributes.</span>
<span class="sd">    It is loaded from the database and updated by proj.</span>

<span class="sd">    Property `support` is the list of table names or other QueryExpressions to be joined.</span>

<span class="sd">    The restriction is applied first without having access to the attributes generated by the projection.</span>
<span class="sd">    Then projection is applied by selecting modifying the heading attribute.</span>

<span class="sd">    Application of operators does not always lead to the creation of a subquery.</span>
<span class="sd">    A subquery is generated when:</span>
<span class="sd">        1. A restriction is applied on any computed or renamed attributes</span>
<span class="sd">        2. A projection is applied remapping remapped attributes</span>
<span class="sd">        3. Subclasses: Join, Aggregation, and Union have additional specific rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_restriction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_restriction_attributes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_left</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of booleans True for left joins, False for inner joins</span>
    <span class="n">_original_heading</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># heading before projections</span>

    <span class="c1"># subclasses or instantiators must provide values</span>
    <span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_heading</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_support</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_top</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If the query will be using distinct</span>
    <span class="n">_distinct</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a dj.Connection object&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of table names or subqueries to from the FROM clause&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_support</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a dj.Heading object, reflects the effects of the projection operator .proj&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heading</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">original_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a dj.Heading object reflecting the attributes before projection&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_heading</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a AndList object of restrictions applied to input to produce the result&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restriction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restriction</span> <span class="o">=</span> <span class="n">AndList</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restriction</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">restriction_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;the set of attribute names invoked in the WHERE clause&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restriction_attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restriction_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restriction_attributes</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">primary_key</span>

    <span class="n">_subquery_alias_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>  <span class="c1"># count for alias names used in the FROM clause</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">src</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;) as `$</span><span class="si">%x</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subquery_alias_count</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">src</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span>
        <span class="p">)</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">support</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">left</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left</span><span class="p">):</span>
            <span class="n">clause</span> <span class="o">+=</span> <span class="s2">&quot; NATURAL</span><span class="si">{left}</span><span class="s2"> JOIN </span><span class="si">{clause}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">left</span><span class="o">=</span><span class="s2">&quot; LEFT&quot;</span> <span class="k">if</span> <span class="n">left</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">clause</span><span class="o">=</span><span class="n">s</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">clause</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
            <span class="k">else</span> <span class="s2">&quot; WHERE (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;)AND(&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sorting_clauses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">_wrap_attributes</span><span class="p">(</span>
                <span class="n">_flatten_attribute_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="n">order_by</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">clause</span><span class="p">:</span>
            <span class="n">clause</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; ORDER BY </span><span class="si">{</span><span class="n">clause</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clause</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; LIMIT </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="n">limit</span><span class="si">}{</span><span class="sa">f</span><span class="s1">&#39; OFFSET </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="n">offset</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">clause</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the SQL SELECT statement.</span>

<span class="sd">        :param fields: used to explicitly set the select attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;SELECT </span><span class="si">{distinct}{fields}</span><span class="s2"> FROM </span><span class="si">{from_}{where}{sorting}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">distinct</span><span class="o">=</span><span class="s2">&quot;DISTINCT &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">),</span>
            <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_clause</span><span class="p">(),</span>
            <span class="n">where</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span><span class="p">(),</span>
            <span class="n">sorting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sorting_clauses</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="c1"># --------- query operators -----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;create a new SELECT statement where self is the FROM clause&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">QueryExpression</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">make_subquery_heading</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restrict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces a new expression with the new restriction applied.</span>
<span class="sd">        rel.restrict(restriction)  is equivalent to  rel &amp; restriction.</span>
<span class="sd">        rel.restrict(Not(restriction))  is equivalent to  rel - restriction</span>
<span class="sd">        The primary key of the result is unaffected.</span>
<span class="sd">        Successive restrictions are combined as logical AND:   r &amp; a &amp; b  is equivalent to r &amp; AndList((a, b))</span>
<span class="sd">        Any QueryExpression, collection, or sequence other than an AndList are treated as OrLists</span>
<span class="sd">        (logical disjunction of conditions)</span>
<span class="sd">        Inverse restriction is accomplished by either using the subtraction operator or the Not class.</span>

<span class="sd">        The expressions in each row equivalent:</span>

<span class="sd">        rel &amp; True                          rel</span>
<span class="sd">        rel &amp; False                         the empty entity set</span>
<span class="sd">        rel &amp; &#39;TRUE&#39;                        rel</span>
<span class="sd">        rel &amp; &#39;FALSE&#39;                       the empty entity set</span>
<span class="sd">        rel - cond                          rel &amp; Not(cond)</span>
<span class="sd">        rel - &#39;TRUE&#39;                        rel &amp; False</span>
<span class="sd">        rel - &#39;FALSE&#39;                       rel</span>
<span class="sd">        rel &amp; AndList((cond1,cond2))        rel &amp; cond1 &amp; cond2</span>
<span class="sd">        rel &amp; AndList()                     rel</span>
<span class="sd">        rel &amp; [cond1, cond2]                rel &amp; OrList((cond1, cond2))</span>
<span class="sd">        rel &amp; []                            rel &amp; False</span>
<span class="sd">        rel &amp; None                          rel &amp; False</span>
<span class="sd">        rel &amp; any_empty_entity_set          rel &amp; False</span>
<span class="sd">        rel - AndList((cond1,cond2))        rel &amp; [Not(cond1), Not(cond2)]</span>
<span class="sd">        rel - [cond1, cond2]                rel &amp; Not(cond1) &amp; Not(cond2)</span>
<span class="sd">        rel - AndList()                     rel &amp; False</span>
<span class="sd">        rel - []                            rel</span>
<span class="sd">        rel - None                          rel</span>
<span class="sd">        rel - any_empty_entity_set          rel</span>

<span class="sd">        When arg is another QueryExpression, the restriction  rel &amp; arg  restricts rel to elements that match at least</span>
<span class="sd">        one element in arg (hence arg is treated as an OrList).</span>
<span class="sd">        Conversely,  rel - arg  restricts rel to elements that do not match any elements in arg.</span>
<span class="sd">        Two elements match when their common attributes have equal values or when they have no common attributes.</span>
<span class="sd">        All shared attributes must be in the primary key of either rel or arg or both or an error will be raised.</span>

<span class="sd">        QueryExpression.restrict is the only access point that modifies restrictions. All other operators must</span>
<span class="sd">        ultimately call restrict()</span>

<span class="sd">        :param restriction: a sequence or an array (treated as OR list), another QueryExpression, an SQL condition</span>
<span class="sd">        string, or an AndList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restriction</span><span class="p">,</span> <span class="n">Top</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># make subquery to avoid overwriting existing Top</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="n">restriction</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">new_condition</span> <span class="o">=</span> <span class="n">make_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_condition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># restriction has no effect, return the same object</span>
        <span class="c1"># check that all attributes in condition are present in the query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` is not found in query.&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>
        <span class="c1"># If the new condition uses any new attributes, a subquery is required.</span>
        <span class="c1"># However, Aggregation&#39;s HAVING statement works fine with aliased attributes.</span>
        <span class="n">need_subquery</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">need_subquery</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span> <span class="o">=</span> <span class="n">AndList</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
            <span class="p">)</span>  <span class="c1"># copy to preserve the original</span>
        <span class="n">result</span><span class="o">.</span><span class="n">restriction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_condition</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">restriction_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restrict_in_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restriction operator e.g. ``q1 &amp; q2``.</span>
<span class="sd">        :return: a restricted copy of the input argument</span>
<span class="sd">        See QueryExpression.restrict for more detail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permissive restriction operator ignoring compatibility check  e.g. ``q1 ^ q2``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">restriction</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">restriction</span> <span class="o">=</span> <span class="n">restriction</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restriction</span><span class="p">,</span> <span class="n">Not</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">PromiscuousOperand</span><span class="p">(</span><span class="n">restriction</span><span class="o">.</span><span class="n">restriction</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">PromiscuousOperand</span><span class="p">(</span><span class="n">restriction</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverted restriction e.g. ``q1 - q2``.</span>
<span class="sd">        :return: a restricted copy of the input argument</span>
<span class="sd">        See QueryExpression.restrict for more detail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">restriction</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert between restriction and inverted restriction e.g. ``-q1``.</span>
<span class="sd">        :return: target restriction</span>
<span class="sd">        See QueryExpression.restrict for more detail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Not</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
        <span class="k">return</span> <span class="n">Not</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        join of query expressions `self` and `other` e.g. ``q1 * q2``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permissive join of query expressions `self` and `other` ignoring compatibility check</span>
<span class="sd">            e.g. ``q1 @ q2``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">semantic_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">semantic_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create the joined QueryExpression.</span>
<span class="sd">        a * b  is short for A.join(B)</span>
<span class="sd">        a @ b  is short for A.join(B, semantic_check=False)</span>
<span class="sd">        Additionally, left=True will retain the rows of self, effectively performing a left join.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># trigger subqueries if joining on renamed attributes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="o">*</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span><span class="s2">&quot;The argument of join must be a QueryExpression&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">semantic_check</span><span class="p">:</span>
            <span class="n">assert_join_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">join_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="c1"># needs subquery if self&#39;s FROM clause has common attributes with other&#39;s FROM clause</span>
        <span class="n">need_subquery1</span> <span class="o">=</span> <span class="n">need_subquery2</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
            <span class="o">-</span> <span class="n">join_attributes</span>
        <span class="p">)</span>
        <span class="c1"># need subquery if any of the join attributes are derived</span>
        <span class="n">need_subquery1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">need_subquery1</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">join_attributes</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">need_subquery2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">need_subquery2</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">join_attributes</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">need_subquery1</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">need_subquery2</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">QueryExpression</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">support</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left</span> <span class="o">+</span> <span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_left</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span> <span class="o">=</span> <span class="n">AndList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_original_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">original_heading</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">support</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_left</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;union e.g. ``q1 + q2``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Union</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Projection operator.</span>

<span class="sd">        :param attributes:  attributes to be included in the result. (The primary key is already included).</span>
<span class="sd">        :param named_attributes: new attributes computed or renamed from existing attributes.</span>
<span class="sd">        :return: the projected expression.</span>
<span class="sd">        Primary key attributes cannot be excluded but may be renamed.</span>
<span class="sd">        If the attribute list contains an Ellipsis ..., then all secondary attributes are included too</span>
<span class="sd">        Prefixing an attribute name with a dash &#39;-attr&#39; removes the attribute from the list if present.</span>
<span class="sd">        Keyword arguments can be used to rename attributes as in name=&#39;attr&#39;, duplicate them as in name=&#39;(attr)&#39;, or</span>
<span class="sd">        self.proj(...) or self.proj(Ellipsis) -- include all attributes (return self)</span>
<span class="sd">        self.proj() -- include only primary key</span>
<span class="sd">        self.proj(&#39;attr1&#39;, &#39;attr2&#39;)  -- include primary key and attributes attr1 and attr2</span>
<span class="sd">        self.proj(..., &#39;-attr1&#39;, &#39;-attr2&#39;)  -- include all attributes except attr1 and attr2</span>
<span class="sd">        self.proj(name1=&#39;attr1&#39;) -- include primary key and &#39;attr1&#39; renamed as name1</span>
<span class="sd">        self.proj(&#39;attr1&#39;, dup=&#39;(attr1)&#39;) -- include primary key and attribute attr1 twice, with the duplicate &#39;dup&#39;</span>
<span class="sd">        self.proj(k=&#39;abs(attr1)&#39;) adds the new attribute k with the value computed as an expression (SQL syntax)</span>
<span class="sd">        from other attributes available before the projection.</span>
<span class="sd">        Each attribute name can only be used once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">named_attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">translate_attribute</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="c1"># new attributes in parentheses are included again with the new name without removing original</span>
        <span class="n">duplication_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s1">&#39;^\s*\(\s*(?!</span><span class="si">{</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONSTANT_LITERALS</span><span class="p">)</span><span class="si">}</span><span class="s1">)(?P&lt;name&gt;[a-zA-Z_]\w*)\s*\)\s*$&#39;</span>
        <span class="p">)</span>
        <span class="c1"># attributes without parentheses renamed</span>
        <span class="n">rename_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s1">&#39;^\s*(?!</span><span class="si">{</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONSTANT_LITERALS</span><span class="p">)</span><span class="si">}</span><span class="s1">)(?P&lt;name&gt;[a-zA-Z_]\w*)\s*$&#39;</span>
        <span class="p">)</span>
        <span class="n">replicate_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">duplication_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span>
        <span class="p">}</span>
        <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">rename_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span>
        <span class="p">}</span>
        <span class="n">compute_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">duplication_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rename_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="c1"># include primary key</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="c1"># include all secondary attributes with Ellipsis</span>
        <span class="k">if</span> <span class="bp">Ellipsis</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">a</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a valid data type for an attribute in .proj&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># normal case</span>
        <span class="c1"># remove excluded attributes, specified as `-attr&#39;</span>
        <span class="n">excluded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">excluded</span><span class="p">)</span>
        <span class="n">excluded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">excluded</span><span class="p">)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">excluded</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot exclude primary key attribute </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">excluded</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>
        <span class="c1"># check that all attributes exist in heading</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` not found.&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>

        <span class="c1"># check that all mentioned names are present in heading</span>
        <span class="n">mentions</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; not found.&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mentions</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>

        <span class="c1"># check that newly created attributes do not clash with any other selected attributes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">a</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rename_map</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">compute_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">a</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">compute_map</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">a</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">replicate_map</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">compute_map</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>

        <span class="c1"># need a subquery if the projection remaps any remapped attributes</span>
        <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">q</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">compute_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">extract_column_names</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">used</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">used</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">replicate_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">used</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">need_subquery</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute_expression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">need_subquery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">:</span>
            <span class="c1"># need a subquery if the restriction applies to attributes that have been renamed</span>
            <span class="n">need_subquery</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction_attributes</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span> <span class="k">if</span> <span class="n">need_subquery</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_original_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">original_heading</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">attributes</span><span class="p">,</span>
            <span class="n">rename_map</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">rename_map</span><span class="p">,</span> <span class="o">**</span><span class="n">replicate_map</span><span class="p">),</span>
            <span class="n">compute_map</span><span class="o">=</span><span class="n">compute_map</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregation of the type U(&#39;attr1&#39;,&#39;attr2&#39;).aggr(group, computation=&quot;QueryExpression&quot;)</span>
<span class="sd">        has the primary key (&#39;attr1&#39;,&#39;attr2&#39;) and performs aggregation computations for all matching elements of `group`.</span>

<span class="sd">        :param group:  The query expression to be aggregated.</span>
<span class="sd">        :param keep_all_rows: True=keep all the rows from self. False=keep only rows that match entries in group.</span>
<span class="sd">        :param named_attributes: computations of the form new_attribute=&quot;sql expression on attributes of group&quot;</span>
<span class="sd">        :return: The derived query expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">Ellipsis</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="c1"># expand ellipsis to include only attributes from the left table</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Aggregation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="n">keep_all_rows</span><span class="p">)</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span>
            <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span>
        <span class="p">)</span>

    <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggr</span>  <span class="c1"># alias for aggr</span>

    <span class="c1"># ---------- Fetch operators --------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Fetch1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        shortcut to fetch the first few entries from query expression.</span>
<span class="sd">        Equivalent to fetch(order_by=&quot;KEY&quot;, limit=25)</span>

<span class="sd">        :param limit:  number of entries</span>
<span class="sd">        :param fetch_kwargs: kwargs for fetch</span>
<span class="sd">        :return: query result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;KEY&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        shortcut to fetch the last few entries from query expression.</span>
<span class="sd">        Equivalent to fetch(order_by=&quot;KEY DESC&quot;, limit=25)[::-1]</span>

<span class="sd">        :param limit:  number of entries</span>
<span class="sd">        :param fetch_kwargs: kwargs for fetch</span>
<span class="sd">        :return: query result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;KEY DESC&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:return: number of elements in the result set e.g. ``len(q1)``.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;SELECT </span><span class="si">{select_}</span><span class="s2"> FROM </span><span class="si">{from_}{where}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">select_</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;count(*)&quot;</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_left</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s2">&quot;count(DISTINCT </span><span class="si">{fields}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fields</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">include_aliases</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">from_</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">from_clause</span><span class="p">(),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">where_clause</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: True if the result is not empty. Equivalent to len(self) &gt; 0 but often</span>
<span class="sd">            faster e.g. ``bool(q1)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;SELECT EXISTS(SELECT 1 FROM </span><span class="si">{from_}{where}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_clause</span><span class="p">(),</span> <span class="n">where</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns True if the restriction in item matches any entries in self</span>
<span class="sd">            e.g. ``restriction in q1``.</span>

<span class="sd">        :param item: any restriction</span>
<span class="sd">        (item in query_expression) is equivalent to bool(query_expression &amp; item) but may be</span>
<span class="sd">        executed more efficiently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span> <span class="o">&amp;</span> <span class="n">item</span><span class="p">)</span>  <span class="c1"># May be optimized e.g. using an EXISTS query</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns an iterator-compatible QueryExpression object e.g. ``iter(q1)``.</span>

<span class="sd">        :param self: iterator-compatible QueryExpression object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_only_key</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">in_key</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the next record on an iterator-compatible QueryExpression object</span>
<span class="sd">            e.g. ``next(q1)``.</span>

<span class="sd">        :param self: A query expression</span>
<span class="sd">        :type self: :class:`QueryExpression`</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># self._iter_keys is missing because __iter__ has not been called.</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;A QueryExpression object is not an iterator. &quot;</span>
                <span class="s2">&quot;Use iter(obj) to create an iterator.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_only_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">DataJointError</span><span class="p">:</span>
                    <span class="c1"># The data may have been deleted since the moment the keys were fetched</span>
                    <span class="c1"># -- move on to next entry.</span>
                    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See expression.fetch() for input description.</span>
<span class="sd">        :return: query cursor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="n">as_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the string representation of a QueryExpression object e.g. ``str(q1)``.</span>

<span class="sd">        :param self: A query expression</span>
<span class="sd">        :type self: :class:`QueryExpression`</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;loglevel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:return: a string of preview of the contents of the query.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:return: HTML to display table in Jupyter notebook.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">repr_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.connection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connection</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.connection" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>a dj.Connection object</p>

    </div>

</div>






<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.support" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">support</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.support" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>A list of table names or subqueries to from the FROM clause</p>

    </div>

</div>






<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.heading" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">heading</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.heading" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>a dj.Heading object, reflects the effects of the projection operator .proj</p>

    </div>

</div>






<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.original_heading" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">original_heading</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.original_heading" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>a dj.Heading object reflecting the attributes before projection</p>

    </div>

</div>






<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.restriction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restriction</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.restriction" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>a AndList object of restrictions applied to input to produce the result</p>

    </div>

</div>






<div class="doc doc-object doc-attribute">



<h3 id="datajoint.expression.QueryExpression.restriction_attributes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restriction_attributes</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#datajoint.expression.QueryExpression.restriction_attributes" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>the set of attribute names invoked in the WHERE clause</p>

    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.make_sql" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_sql</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.make_sql" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make the SQL SELECT statement.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fields</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>used to explicitly set the select attributes</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make the SQL SELECT statement.</span>

<span class="sd">    :param fields: used to explicitly set the select attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;SELECT </span><span class="si">{distinct}{fields}</span><span class="s2"> FROM </span><span class="si">{from_}{where}{sorting}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">distinct</span><span class="o">=</span><span class="s2">&quot;DISTINCT &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">),</span>
        <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_clause</span><span class="p">(),</span>
        <span class="n">where</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span><span class="p">(),</span>
        <span class="n">sorting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sorting_clauses</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.make_subquery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_subquery</span><span class="p">()</span></code>

<a href="#datajoint.expression.QueryExpression.make_subquery" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>create a new SELECT statement where self is the FROM clause</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;create a new SELECT statement where self is the FROM clause&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">QueryExpression</span><span class="p">()</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">make_subquery_heading</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.restrict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restrict</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.restrict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Produces a new expression with the new restriction applied.
rel.restrict(restriction)  is equivalent to  rel &amp; restriction.
rel.restrict(Not(restriction))  is equivalent to  rel - restriction
The primary key of the result is unaffected.
Successive restrictions are combined as logical AND:   r &amp; a &amp; b  is equivalent to r &amp; AndList((a, b))
Any QueryExpression, collection, or sequence other than an AndList are treated as OrLists
(logical disjunction of conditions)
Inverse restriction is accomplished by either using the subtraction operator or the Not class.</p>
<p>The expressions in each row equivalent:</p>
<p>rel &amp; True                          rel
rel &amp; False                         the empty entity set
rel &amp; 'TRUE'                        rel
rel &amp; 'FALSE'                       the empty entity set
rel - cond                          rel &amp; Not(cond)
rel - 'TRUE'                        rel &amp; False
rel - 'FALSE'                       rel
rel &amp; AndList((cond1,cond2))        rel &amp; cond1 &amp; cond2
rel &amp; AndList()                     rel
rel &amp; [cond1, cond2]                rel &amp; OrList((cond1, cond2))
rel &amp; []                            rel &amp; False
rel &amp; None                          rel &amp; False
rel &amp; any_empty_entity_set          rel &amp; False
rel - AndList((cond1,cond2))        rel &amp; [Not(cond1), Not(cond2)]
rel - [cond1, cond2]                rel &amp; Not(cond1) &amp; Not(cond2)
rel - AndList()                     rel &amp; False
rel - []                            rel
rel - None                          rel
rel - any_empty_entity_set          rel</p>
<p>When arg is another QueryExpression, the restriction  rel &amp; arg  restricts rel to elements that match at least
one element in arg (hence arg is treated as an OrList).
Conversely,  rel - arg  restricts rel to elements that do not match any elements in arg.
Two elements match when their common attributes have equal values or when they have no common attributes.
All shared attributes must be in the primary key of either rel or arg or both or an error will be raised.</p>
<p>QueryExpression.restrict is the only access point that modifies restrictions. All other operators must
ultimately call restrict()</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>restriction</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a sequence or an array (treated as OR list), another QueryExpression, an SQL condition
string, or an AndList.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">restrict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces a new expression with the new restriction applied.</span>
<span class="sd">    rel.restrict(restriction)  is equivalent to  rel &amp; restriction.</span>
<span class="sd">    rel.restrict(Not(restriction))  is equivalent to  rel - restriction</span>
<span class="sd">    The primary key of the result is unaffected.</span>
<span class="sd">    Successive restrictions are combined as logical AND:   r &amp; a &amp; b  is equivalent to r &amp; AndList((a, b))</span>
<span class="sd">    Any QueryExpression, collection, or sequence other than an AndList are treated as OrLists</span>
<span class="sd">    (logical disjunction of conditions)</span>
<span class="sd">    Inverse restriction is accomplished by either using the subtraction operator or the Not class.</span>

<span class="sd">    The expressions in each row equivalent:</span>

<span class="sd">    rel &amp; True                          rel</span>
<span class="sd">    rel &amp; False                         the empty entity set</span>
<span class="sd">    rel &amp; &#39;TRUE&#39;                        rel</span>
<span class="sd">    rel &amp; &#39;FALSE&#39;                       the empty entity set</span>
<span class="sd">    rel - cond                          rel &amp; Not(cond)</span>
<span class="sd">    rel - &#39;TRUE&#39;                        rel &amp; False</span>
<span class="sd">    rel - &#39;FALSE&#39;                       rel</span>
<span class="sd">    rel &amp; AndList((cond1,cond2))        rel &amp; cond1 &amp; cond2</span>
<span class="sd">    rel &amp; AndList()                     rel</span>
<span class="sd">    rel &amp; [cond1, cond2]                rel &amp; OrList((cond1, cond2))</span>
<span class="sd">    rel &amp; []                            rel &amp; False</span>
<span class="sd">    rel &amp; None                          rel &amp; False</span>
<span class="sd">    rel &amp; any_empty_entity_set          rel &amp; False</span>
<span class="sd">    rel - AndList((cond1,cond2))        rel &amp; [Not(cond1), Not(cond2)]</span>
<span class="sd">    rel - [cond1, cond2]                rel &amp; Not(cond1) &amp; Not(cond2)</span>
<span class="sd">    rel - AndList()                     rel &amp; False</span>
<span class="sd">    rel - []                            rel</span>
<span class="sd">    rel - None                          rel</span>
<span class="sd">    rel - any_empty_entity_set          rel</span>

<span class="sd">    When arg is another QueryExpression, the restriction  rel &amp; arg  restricts rel to elements that match at least</span>
<span class="sd">    one element in arg (hence arg is treated as an OrList).</span>
<span class="sd">    Conversely,  rel - arg  restricts rel to elements that do not match any elements in arg.</span>
<span class="sd">    Two elements match when their common attributes have equal values or when they have no common attributes.</span>
<span class="sd">    All shared attributes must be in the primary key of either rel or arg or both or an error will be raised.</span>

<span class="sd">    QueryExpression.restrict is the only access point that modifies restrictions. All other operators must</span>
<span class="sd">    ultimately call restrict()</span>

<span class="sd">    :param restriction: a sequence or an array (treated as OR list), another QueryExpression, an SQL condition</span>
<span class="sd">    string, or an AndList.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restriction</span><span class="p">,</span> <span class="n">Top</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">restriction</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># make subquery to avoid overwriting existing Top</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="n">restriction</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">new_condition</span> <span class="o">=</span> <span class="n">make_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restriction</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_condition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># restriction has no effect, return the same object</span>
    <span class="c1"># check that all attributes in condition are present in the query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` is not found in query.&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>
    <span class="c1"># If the new condition uses any new attributes, a subquery is required.</span>
    <span class="c1"># However, Aggregation&#39;s HAVING statement works fine with aliased attributes.</span>
    <span class="n">need_subquery</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">need_subquery</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span> <span class="o">=</span> <span class="n">AndList</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
        <span class="p">)</span>  <span class="c1"># copy to preserve the original</span>
    <span class="n">result</span><span class="o">.</span><span class="n">restriction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_condition</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">restriction_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.join" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">semantic_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.join" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>create the joined QueryExpression.
a * b  is short for A.join(B)
a @ b  is short for A.join(B, semantic_check=False)
Additionally, left=True will retain the rows of self, effectively performing a left join.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">semantic_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create the joined QueryExpression.</span>
<span class="sd">    a * b  is short for A.join(B)</span>
<span class="sd">    a @ b  is short for A.join(B, semantic_check=False)</span>
<span class="sd">    Additionally, left=True will retain the rows of self, effectively performing a left join.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># trigger subqueries if joining on renamed attributes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">*</span> <span class="bp">self</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span><span class="s2">&quot;The argument of join must be a QueryExpression&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">semantic_check</span><span class="p">:</span>
        <span class="n">assert_join_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="n">join_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="c1"># needs subquery if self&#39;s FROM clause has common attributes with other&#39;s FROM clause</span>
    <span class="n">need_subquery1</span> <span class="o">=</span> <span class="n">need_subquery2</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
        <span class="o">-</span> <span class="n">join_attributes</span>
    <span class="p">)</span>
    <span class="c1"># need subquery if any of the join attributes are derived</span>
    <span class="n">need_subquery1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">need_subquery1</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">join_attributes</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">need_subquery2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">need_subquery2</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Aggregation</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">join_attributes</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">need_subquery1</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">need_subquery2</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">QueryExpression</span><span class="p">()</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">support</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left</span> <span class="o">+</span> <span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_left</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span> <span class="o">=</span> <span class="n">AndList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_restriction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_original_heading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_heading</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">original_heading</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">support</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_left</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.proj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">proj</span><span class="p">(</span><span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.proj" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Projection operator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>attributes</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>attributes to be included in the result. (The primary key is already included).</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>named_attributes</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>new attributes computed or renamed from existing attributes.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the projected expression.
Primary key attributes cannot be excluded but may be renamed.
If the attribute list contains an Ellipsis ..., then all secondary attributes are included too
Prefixing an attribute name with a dash '-attr' removes the attribute from the list if present.
Keyword arguments can be used to rename attributes as in name='attr', duplicate them as in name='(attr)', or
self.proj(...) or self.proj(Ellipsis) -- include all attributes (return self)
self.proj() -- include only primary key
self.proj('attr1', 'attr2')  -- include primary key and attributes attr1 and attr2
self.proj(..., '-attr1', '-attr2')  -- include all attributes except attr1 and attr2
self.proj(name1='attr1') -- include primary key and 'attr1' renamed as name1
self.proj('attr1', dup='(attr1)') -- include primary key and attribute attr1 twice, with the duplicate 'dup'
self.proj(k='abs(attr1)') adds the new attribute k with the value computed as an expression (SQL syntax)
from other attributes available before the projection.
Each attribute name can only be used once.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Projection operator.</span>

<span class="sd">    :param attributes:  attributes to be included in the result. (The primary key is already included).</span>
<span class="sd">    :param named_attributes: new attributes computed or renamed from existing attributes.</span>
<span class="sd">    :return: the projected expression.</span>
<span class="sd">    Primary key attributes cannot be excluded but may be renamed.</span>
<span class="sd">    If the attribute list contains an Ellipsis ..., then all secondary attributes are included too</span>
<span class="sd">    Prefixing an attribute name with a dash &#39;-attr&#39; removes the attribute from the list if present.</span>
<span class="sd">    Keyword arguments can be used to rename attributes as in name=&#39;attr&#39;, duplicate them as in name=&#39;(attr)&#39;, or</span>
<span class="sd">    self.proj(...) or self.proj(Ellipsis) -- include all attributes (return self)</span>
<span class="sd">    self.proj() -- include only primary key</span>
<span class="sd">    self.proj(&#39;attr1&#39;, &#39;attr2&#39;)  -- include primary key and attributes attr1 and attr2</span>
<span class="sd">    self.proj(..., &#39;-attr1&#39;, &#39;-attr2&#39;)  -- include all attributes except attr1 and attr2</span>
<span class="sd">    self.proj(name1=&#39;attr1&#39;) -- include primary key and &#39;attr1&#39; renamed as name1</span>
<span class="sd">    self.proj(&#39;attr1&#39;, dup=&#39;(attr1)&#39;) -- include primary key and attribute attr1 twice, with the duplicate &#39;dup&#39;</span>
<span class="sd">    self.proj(k=&#39;abs(attr1)&#39;) adds the new attribute k with the value computed as an expression (SQL syntax)</span>
<span class="sd">    from other attributes available before the projection.</span>
<span class="sd">    Each attribute name can only be used once.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">named_attributes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">translate_attribute</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1"># new attributes in parentheses are included again with the new name without removing original</span>
    <span class="n">duplication_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">rf</span><span class="s1">&#39;^\s*\(\s*(?!</span><span class="si">{</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONSTANT_LITERALS</span><span class="p">)</span><span class="si">}</span><span class="s1">)(?P&lt;name&gt;[a-zA-Z_]\w*)\s*\)\s*$&#39;</span>
    <span class="p">)</span>
    <span class="c1"># attributes without parentheses renamed</span>
    <span class="n">rename_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">rf</span><span class="s1">&#39;^\s*(?!</span><span class="si">{</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONSTANT_LITERALS</span><span class="p">)</span><span class="si">}</span><span class="s1">)(?P&lt;name&gt;[a-zA-Z_]\w*)\s*$&#39;</span>
    <span class="p">)</span>
    <span class="n">replicate_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">duplication_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span>
    <span class="p">}</span>
    <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">rename_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span>
    <span class="p">}</span>
    <span class="n">compute_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">duplication_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rename_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="c1"># include primary key</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="c1"># include all secondary attributes with Ellipsis</span>
    <span class="k">if</span> <span class="bp">Ellipsis</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a valid data type for an attribute in .proj&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># normal case</span>
    <span class="c1"># remove excluded attributes, specified as `-attr&#39;</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">excluded</span><span class="p">)</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">excluded</span><span class="p">)</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">excluded</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot exclude primary key attribute </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">excluded</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>
    <span class="c1"># check that all attributes exist in heading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` not found.&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>

    <span class="c1"># check that all mentioned names are present in heading</span>
    <span class="n">mentions</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; not found.&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mentions</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>

    <span class="c1"># check that newly created attributes do not clash with any other selected attributes</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rename_map</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">compute_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">compute_map</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">replicate_map</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` already exists&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">replicate_map</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rename_map</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">compute_map</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>

    <span class="c1"># need a subquery if the projection remaps any remapped attributes</span>
    <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">q</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">compute_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">extract_column_names</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">used</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">used</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">replicate_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">used</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="n">need_subquery</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute_expression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">need_subquery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">:</span>
        <span class="c1"># need a subquery if the restriction applies to attributes that have been renamed</span>
        <span class="n">need_subquery</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction_attributes</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span> <span class="k">if</span> <span class="n">need_subquery</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_original_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">original_heading</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">attributes</span><span class="p">,</span>
        <span class="n">rename_map</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">rename_map</span><span class="p">,</span> <span class="o">**</span><span class="n">replicate_map</span><span class="p">),</span>
        <span class="n">compute_map</span><span class="o">=</span><span class="n">compute_map</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.aggr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.aggr" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Aggregation of the type U('attr1','attr2').aggr(group, computation="QueryExpression")
has the primary key ('attr1','attr2') and performs aggregation computations for all matching elements of <code>group</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>group</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query expression to be aggregated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_all_rows</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True=keep all the rows from self. False=keep only rows that match entries in group.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>named_attributes</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>computations of the form new_attribute="sql expression on attributes of group"</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The derived query expression</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregation of the type U(&#39;attr1&#39;,&#39;attr2&#39;).aggr(group, computation=&quot;QueryExpression&quot;)</span>
<span class="sd">    has the primary key (&#39;attr1&#39;,&#39;attr2&#39;) and performs aggregation computations for all matching elements of `group`.</span>

<span class="sd">    :param group:  The query expression to be aggregated.</span>
<span class="sd">    :param keep_all_rows: True=keep all the rows from self. False=keep only rows that match entries in group.</span>
<span class="sd">    :param named_attributes: computations of the form new_attribute=&quot;sql expression on attributes of group&quot;</span>
<span class="sd">    :return: The derived query expression</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">Ellipsis</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="c1"># expand ellipsis to include only attributes from the left table</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Aggregation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="n">keep_all_rows</span><span class="p">)</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span>
        <span class="o">*</span><span class="n">attributes</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.head" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">head</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.head" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>shortcut to fetch the first few entries from query expression.
Equivalent to fetch(order_by="KEY", limit=25)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of entries</p>
              </div>
            </td>
            <td>
                  <code>25</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fetch_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>kwargs for fetch</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>query result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    shortcut to fetch the first few entries from query expression.</span>
<span class="sd">    Equivalent to fetch(order_by=&quot;KEY&quot;, limit=25)</span>

<span class="sd">    :param limit:  number of entries</span>
<span class="sd">    :param fetch_kwargs: kwargs for fetch</span>
<span class="sd">    :return: query result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;KEY&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.tail" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tail</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.tail" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>shortcut to fetch the last few entries from query expression.
Equivalent to fetch(order_by="KEY DESC", limit=25)[::-1]</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of entries</p>
              </div>
            </td>
            <td>
                  <code>25</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fetch_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>kwargs for fetch</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>query result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    shortcut to fetch the last few entries from query expression.</span>
<span class="sd">    Equivalent to fetch(order_by=&quot;KEY DESC&quot;, limit=25)[::-1]</span>

<span class="sd">    :param limit:  number of entries</span>
<span class="sd">    :param fetch_kwargs: kwargs for fetch</span>
<span class="sd">    :return: query result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;KEY DESC&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_kwargs</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.cursor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cursor</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.cursor" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>See expression.fetch() for input description.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>query cursor</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See expression.fetch() for input description.</span>
<span class="sd">    :return: query cursor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="n">as_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.QueryExpression.preview" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preview</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#datajoint.expression.QueryExpression.preview" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a string of preview of the contents of the query.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:return: a string of preview of the contents of the query.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="datajoint.expression.Aggregation" class="doc doc-heading">
            <code>Aggregation</code>


<a href="#datajoint.expression.Aggregation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="QueryExpression (datajoint.expression.QueryExpression)" href="#datajoint.expression.QueryExpression">QueryExpression</a></code></p>



        <p>Aggregation.create(arg, group, comp1='calc1', ..., compn='calcn')  yields an entity set
with primary key from arg.
The computed arguments comp1, ..., compn use aggregation calculations on the attributes of
group or simple projections and calculations on the attributes of arg.
Aggregation is used QueryExpression.aggr and U.aggr.
Aggregation is a private class in DataJoint, not exposed to users.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>datajoint/expression.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Aggregation</span><span class="p">(</span><span class="n">QueryExpression</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregation.create(arg, group, comp1=&#39;calc1&#39;, ..., compn=&#39;calcn&#39;)  yields an entity set</span>
<span class="sd">    with primary key from arg.</span>
<span class="sd">    The computed arguments comp1, ..., compn use aggregation calculations on the attributes of</span>
<span class="sd">    group or simple projections and calculations on the attributes of arg.</span>
<span class="sd">    Aggregation is used QueryExpression.aggr and U.aggr.</span>
<span class="sd">    Aggregation is a private class in DataJoint, not exposed to users.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_left_restrict</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the pre-GROUP BY conditions for the WHERE clause</span>
    <span class="n">_subquery_alias_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">()</span>  <span class="c1"># instantiate if a class</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_all_rows</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">support</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">group</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">new_attributes</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">make_subquery</span><span class="p">()</span>  <span class="c1"># subquery if left joining a join</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">keep_all_rows</span><span class="p">)</span>  <span class="c1"># reuse the join logic</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">set_primary_key</span><span class="p">(</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="p">)</span>  <span class="c1"># use left operand&#39;s primary key</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">support</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_left</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">_left</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_left_restrict</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">restriction</span>  <span class="c1"># WHERE clause applied before GROUP BY</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_grouping_attributes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">primary_key</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_restrict</span>
            <span class="k">else</span> <span class="s2">&quot; WHERE (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;)AND(&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_restrict</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouping_attributes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
        <span class="n">distinct</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;SELECT </span><span class="si">{distinct}{fields}</span><span class="s2"> FROM </span><span class="si">{from_}{where}{group_by}{sorting}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">distinct</span><span class="o">=</span><span class="s2">&quot;DISTINCT &quot;</span> <span class="k">if</span> <span class="n">distinct</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_clause</span><span class="p">(),</span>
                <span class="n">where</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span><span class="p">(),</span>
                <span class="n">group_by</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span>
                    <span class="k">else</span> <span class="p">(</span>
                        <span class="s2">&quot; GROUP BY `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="s2">&quot;`,`&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grouping_attributes</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">(</span>
                            <span class="s2">&quot;&quot;</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restriction</span>
                            <span class="k">else</span> <span class="s2">&quot; HAVING (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;)AND(&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">sorting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sorting_clauses</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;SELECT count(1) FROM (</span><span class="si">{subquery}</span><span class="s2">) `$</span><span class="si">{alias:x}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">subquery</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">(),</span> <span class="n">alias</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subquery_alias_count</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(</span><span class="si">{sql}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()))</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="datajoint.expression.Union" class="doc doc-heading">
            <code>Union</code>


<a href="#datajoint.expression.Union" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="QueryExpression (datajoint.expression.QueryExpression)" href="#datajoint.expression.QueryExpression">QueryExpression</a></code></p>



        <p>Union is the private DataJoint class that implements the union operator.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>datajoint/expression.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Union</span><span class="p">(</span><span class="n">QueryExpression</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Union is the private DataJoint class that implements the union operator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__count</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">arg2</span> <span class="o">=</span> <span class="n">arg2</span><span class="p">()</span>  <span class="c1"># instantiate if a class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;A QueryExpression can only be unioned with another QueryExpression&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">arg1</span><span class="o">.</span><span class="n">connection</span> <span class="o">!=</span> <span class="n">arg2</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot operate on QueryExpressions originating from different connections.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">arg1</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arg2</span><span class="o">.</span><span class="n">primary_key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;The operands of a union must share the same primary key.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">arg1</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">arg2</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;The operands of a union must not share any secondary attributes.&quot;</span>
            <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg2</span><span class="o">.</span><span class="n">heading</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_support</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">arg1</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg2</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span>
        <span class="p">):</span>
            <span class="c1"># no secondary attributes: use UNION DISTINCT</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">.</span><span class="n">primary_key</span>
            <span class="k">return</span> <span class="s2">&quot;SELECT * FROM ((</span><span class="si">{sql1}</span><span class="s2">) UNION (</span><span class="si">{sql2}</span><span class="s2">)) as `_u</span><span class="si">{alias}{sorting}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sql1</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">arg1</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">arg1</span><span class="o">.</span><span class="n">make_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">sql2</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">arg2</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">arg2</span><span class="o">.</span><span class="n">make_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">alias</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__count</span><span class="p">),</span>
                <span class="n">sorting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sorting_clauses</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="c1"># with secondary attributes, use union of left join with antijoin</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span>
        <span class="n">sql1</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">make_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">sql2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">arg2</span> <span class="o">-</span> <span class="n">arg1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s2">&quot;NULL&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">arg1</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">secondary_attributes</span><span class="p">})</span>
            <span class="o">.</span><span class="n">make_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">{sql1}</span><span class="s2">)  UNION (</span><span class="si">{sql2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql1</span><span class="o">=</span><span class="n">sql1</span><span class="p">,</span> <span class="n">sql2</span><span class="o">=</span><span class="n">sql2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The union does not use a FROM clause&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The union does not use a WHERE clause&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;SELECT count(1) FROM (</span><span class="si">{subquery}</span><span class="s2">) `$</span><span class="si">{alias:x}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">subquery</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">(),</span>
                <span class="n">alias</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">QueryExpression</span><span class="o">.</span><span class="n">_subquery_alias_count</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(</span><span class="si">{sql}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sql</span><span class="p">()))</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.Union.from_clause" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_clause</span><span class="p">()</span></code>

<a href="#datajoint.expression.Union.from_clause" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>The union does not use a FROM clause</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The union does not use a FROM clause&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.Union.where_clause" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">where_clause</span><span class="p">()</span></code>

<a href="#datajoint.expression.Union.where_clause" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>The union does not use a WHERE clause</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The union does not use a WHERE clause&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="datajoint.expression.U" class="doc doc-heading">
            <code>U</code>


<a href="#datajoint.expression.U" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>dj.U objects are the universal sets representing all possible values of their attributes.
dj.U objects cannot be queried on their own but are useful for forming some queries.
dj.U('attr1', ..., 'attrn') represents the universal set with the primary key attributes attr1 ... attrn.
The universal set is the set of all possible combinations of values of the attributes.
Without any attributes, dj.U() represents the set with one element that has no attributes.</p>
<p>Restriction:</p>
<p>dj.U can be used to enumerate unique combinations of values of attributes from other expressions.</p>
<p>The following expression yields all unique combinations of contrast and brightness found in the <code>stimulus</code> set:</p>
<blockquote>
<blockquote>
<blockquote>
<p>dj.U('contrast', 'brightness') &amp; stimulus</p>
</blockquote>
</blockquote>
</blockquote>
<p>Aggregation:</p>
<p>In aggregation, dj.U is used for summary calculation over an entire set:</p>
<p>The following expression yields one element with one attribute <code>s</code> containing the total number of elements in
query expression <code>expr</code>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>dj.U().aggr(expr, n='count(*)')</p>
</blockquote>
</blockquote>
</blockquote>
<p>The following expressions both yield one element containing the number <code>n</code> of distinct values of attribute <code>attr</code> in
query expression <code>expr</code>.</p>
<blockquote>
<blockquote>
<blockquote>
<p>dj.U().aggr(expr, n='count(distinct attr)')
dj.U().aggr(dj.U('attr').aggr(expr), 'n=count(*)')</p>
</blockquote>
</blockquote>
</blockquote>
<p>The following expression yields one element and one attribute <code>s</code> containing the sum of values of attribute <code>attr</code>
over entire result set of expression <code>expr</code>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>dj.U().aggr(expr, s='sum(attr)')</p>
</blockquote>
</blockquote>
</blockquote>
<p>The following expression yields the set of all unique combinations of attributes <code>attr1</code>, <code>attr2</code> and the number of
their occurrences in the result set of query expression <code>expr</code>.</p>
<blockquote>
<blockquote>
<blockquote>
<p>dj.U(attr1,attr2).aggr(expr, n='count(*)')</p>
</blockquote>
</blockquote>
</blockquote>
<p>Joins:</p>
<p>If expression <code>expr</code> has attributes 'attr1' and 'attr2', then expr * dj.U('attr1','attr2') yields the same result
as <code>expr</code> but <code>attr1</code> and <code>attr2</code> are promoted to the the primary key.  This is useful for producing a join on
non-primary key attributes.
For example, if <code>attr</code> is in both expr1 and expr2 but not in their primary keys, then expr1 * expr2 will throw
an error because in most cases, it does not make sense to join on non-primary key attributes and users must first
rename <code>attr</code> in one of the operands.  The expression dj.U('attr') * rel1 * rel2 overrides this constraint.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>datajoint/expression.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">U</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    dj.U objects are the universal sets representing all possible values of their attributes.</span>
<span class="sd">    dj.U objects cannot be queried on their own but are useful for forming some queries.</span>
<span class="sd">    dj.U(&#39;attr1&#39;, ..., &#39;attrn&#39;) represents the universal set with the primary key attributes attr1 ... attrn.</span>
<span class="sd">    The universal set is the set of all possible combinations of values of the attributes.</span>
<span class="sd">    Without any attributes, dj.U() represents the set with one element that has no attributes.</span>

<span class="sd">    Restriction:</span>

<span class="sd">    dj.U can be used to enumerate unique combinations of values of attributes from other expressions.</span>

<span class="sd">    The following expression yields all unique combinations of contrast and brightness found in the `stimulus` set:</span>

<span class="sd">    &gt;&gt;&gt; dj.U(&#39;contrast&#39;, &#39;brightness&#39;) &amp; stimulus</span>

<span class="sd">    Aggregation:</span>

<span class="sd">    In aggregation, dj.U is used for summary calculation over an entire set:</span>

<span class="sd">    The following expression yields one element with one attribute `s` containing the total number of elements in</span>
<span class="sd">    query expression `expr`:</span>

<span class="sd">    &gt;&gt;&gt; dj.U().aggr(expr, n=&#39;count(*)&#39;)</span>

<span class="sd">    The following expressions both yield one element containing the number `n` of distinct values of attribute `attr` in</span>
<span class="sd">    query expression `expr`.</span>

<span class="sd">    &gt;&gt;&gt; dj.U().aggr(expr, n=&#39;count(distinct attr)&#39;)</span>
<span class="sd">    &gt;&gt;&gt; dj.U().aggr(dj.U(&#39;attr&#39;).aggr(expr), &#39;n=count(*)&#39;)</span>

<span class="sd">    The following expression yields one element and one attribute `s` containing the sum of values of attribute `attr`</span>
<span class="sd">    over entire result set of expression `expr`:</span>

<span class="sd">    &gt;&gt;&gt; dj.U().aggr(expr, s=&#39;sum(attr)&#39;)</span>

<span class="sd">    The following expression yields the set of all unique combinations of attributes `attr1`, `attr2` and the number of</span>
<span class="sd">    their occurrences in the result set of query expression `expr`.</span>

<span class="sd">    &gt;&gt;&gt; dj.U(attr1,attr2).aggr(expr, n=&#39;count(*)&#39;)</span>

<span class="sd">    Joins:</span>

<span class="sd">    If expression `expr` has attributes &#39;attr1&#39; and &#39;attr2&#39;, then expr * dj.U(&#39;attr1&#39;,&#39;attr2&#39;) yields the same result</span>
<span class="sd">    as `expr` but `attr1` and `attr2` are promoted to the the primary key.  This is useful for producing a join on</span>
<span class="sd">    non-primary key attributes.</span>
<span class="sd">    For example, if `attr` is in both expr1 and expr2 but not in their primary keys, then expr1 * expr2 will throw</span>
<span class="sd">    an error because in most cases, it does not make sense to join on non-primary key attributes and users must first</span>
<span class="sd">    rename `attr` in one of the operands.  The expression dj.U(&#39;attr&#39;) * rel1 * rel2 overrides this constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">primary_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate if a class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span><span class="s2">&quot;Set U can only be restricted with a QueryExpression.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">set_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Joining U with a query expression has the effect of promoting the attributes of U to</span>
<span class="sd">        the primary key of the other query expression.</span>

<span class="sd">        :param other: the other query expression to join with.</span>
<span class="sd">        :param left: ignored. dj.U always acts as if left=False</span>
<span class="sd">        :return: a copy of the other query expression with the primary key extended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate if a class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span><span class="s2">&quot;Set U can only be joined with a QueryExpression.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` not found&quot;</span>
                <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># all ok</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">set_primary_key</span><span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="n">primary_key</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;shorthand for join&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregation of the type U(&#39;attr1&#39;,&#39;attr2&#39;).aggr(group, computation=&quot;QueryExpression&quot;)</span>
<span class="sd">        has the primary key (&#39;attr1&#39;,&#39;attr2&#39;) and performs aggregation computations for all matching elements of `group`.</span>

<span class="sd">        :param group:  The query expression to be aggregated.</span>
<span class="sd">        :param named_attributes: computations of the form new_attribute=&quot;sql expression on attributes of group&quot;</span>
<span class="sd">        :return: The derived query expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_all_rows&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot set keep_all_rows=True when aggregating on a universal set.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Aggregation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span>
            <span class="o">**</span><span class="n">named_attributes</span>
        <span class="p">)</span>

    <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggr</span>  <span class="c1"># alias for aggr</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.U.join" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#datajoint.expression.U.join" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Joining U with a query expression has the effect of promoting the attributes of U to
the primary key of the other query expression.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>other</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the other query expression to join with.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ignored. dj.U always acts as if left=False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a copy of the other query expression with the primary key extended.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Joining U with a query expression has the effect of promoting the attributes of U to</span>
<span class="sd">    the primary key of the other query expression.</span>

<span class="sd">    :param other: the other query expression to join with.</span>
<span class="sd">    :param left: ignored. dj.U always acts as if left=False</span>
<span class="sd">    :return: a copy of the other query expression with the primary key extended.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">()</span>  <span class="c1"># instantiate if a class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryExpression</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span><span class="s2">&quot;Set U can only be joined with a QueryExpression.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Attribute `</span><span class="si">%s</span><span class="s2">` not found&quot;</span>
            <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># all ok</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_heading</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">set_primary_key</span><span class="p">(</span>
        <span class="n">other</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="datajoint.expression.U.aggr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">)</span></code>

<a href="#datajoint.expression.U.aggr" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Aggregation of the type U('attr1','attr2').aggr(group, computation="QueryExpression")
has the primary key ('attr1','attr2') and performs aggregation computations for all matching elements of <code>group</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>group</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query expression to be aggregated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>named_attributes</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>computations of the form new_attribute="sql expression on attributes of group"</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The derived query expression</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>datajoint/expression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">named_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregation of the type U(&#39;attr1&#39;,&#39;attr2&#39;).aggr(group, computation=&quot;QueryExpression&quot;)</span>
<span class="sd">    has the primary key (&#39;attr1&#39;,&#39;attr2&#39;) and performs aggregation computations for all matching elements of `group`.</span>

<span class="sd">    :param group:  The query expression to be aggregated.</span>
<span class="sd">    :param named_attributes: computations of the form new_attribute=&quot;sql expression on attributes of group&quot;</span>
<span class="sd">    :return: The derived query expression</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">named_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_all_rows&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DataJointError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot set keep_all_rows=True when aggregating on a universal set.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">Aggregation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">keep_all_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span>
        <span class="o">**</span><span class="n">named_attributes</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://www.datajoint.com" target="_blank" rel="noopener" title="DataJoint" class="md-social__link">
      <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>
    </a>
  
    
    
    
    
    <a href="https://datajoint.slack.com" target="_blank" rel="noopener" title="Slack" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M94.1 315.1c0 25.9-21.2 47.1-47.1 47.1S0 341 0 315.1 21.2 268 47.1 268h47.1v47.1zm23.7 0c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1v117.8c0 25.9-21.2 47.1-47.1 47.1s-47.1-21.2-47.1-47.1zm47.1-189c-25.9 0-47.1-21.2-47.1-47.1s21.2-47 47.1-47S212 53.2 212 79.1v47.1h-47.1zm0 23.7c25.9 0 47.1 21.2 47.1 47.1S190.8 244 164.9 244H47.1C21.2 244 0 222.8 0 196.9s21.2-47.1 47.1-47.1zm189 47.1c0-25.9 21.2-47.1 47.1-47.1s47 21.2 47 47.1-21.2 47.1-47.1 47.1h-47.1v-47.1zm-23.7 0c0 25.9-21.2 47.1-47.1 47.1S236 222.8 236 196.9V79.1c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1zm-47.1 189c25.9 0 47.1 21.2 47.1 47.1s-21.2 47-47.1 47-47.1-21.2-47.1-47.1v-47.1h47.1zm0-23.7c-25.9 0-47.1-21.2-47.1-47.1s21.2-47.1 47.1-47.1h117.8c25.9 0 47.1 21.2 47.1 47.1s-21.2 47.1-47.1 47.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/company/datajoint" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://twitter.com/datajoint" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/datajoint" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://hub.docker.com/u/datajoint" target="_blank" rel="noopener" title="DockerHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://pypi.org/user/datajointbot" target="_blank" rel="noopener" title="PyPI" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
    
    
    
    
    <a href="https://stackoverflow.com/questions/tagged/datajoint" target="_blank" rel="noopener" title="StackOverflow" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M291 311 95.3 269.7 87.1 309l195.7 41zm51-87L188.5 95.7 163 126.5l153.5 128.3zm-31.2 39.7L129.5 179l-16.7 36.5L294 300zM262.3 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H43V320H3v160h359.5V320h-40z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.youtube.com/channel/UCdeCuFOTCXlVMRzh6Wk-lGg" target="_blank" rel="noopener" title="YouTube" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M549.7 124.1c-6.2-23.7-24.8-42.3-48.3-48.6C458.9 64 288.1 64 288.1 64S117.3 64 74.7 75.5c-23.5 6.3-42 24.9-48.3 48.6C15 167 15 256.4 15 256.4s0 89.4 11.4 132.3c6.3 23.6 24.8 41.5 48.3 47.8C117.3 448 288.1 448 288.1 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232.2 337.6V175.2l142.7 81.2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["toc.integrate", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>